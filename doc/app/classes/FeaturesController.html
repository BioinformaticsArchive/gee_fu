<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: FeaturesController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">FeaturesController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/features_controller_rb.html">
                app/controllers/features_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Defines the URL methods that co-ordinate and respond to requests
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000063">annoj</a>&nbsp;&nbsp;
      <a href="#M000064">chromosome</a>&nbsp;&nbsp;
      <a href="#M000061">coverage</a>&nbsp;&nbsp;
      <a href="#M000070">describe</a>&nbsp;&nbsp;
      <a href="#M000059">destroy</a>&nbsp;&nbsp;
      <a href="#M000056">edit</a>&nbsp;&nbsp;
      <a href="#M000068">get_boxes</a>&nbsp;&nbsp;
      <a href="#M000067">get_histogram</a>&nbsp;&nbsp;
      <a href="#M000069">get_reads</a>&nbsp;&nbsp;
      <a href="#M000060">graphic_range</a>&nbsp;&nbsp;
      <a href="#M000055">index</a>&nbsp;&nbsp;
      <a href="#M000071">lookup</a>&nbsp;&nbsp;
      <a href="#M000072">new_response</a>&nbsp;&nbsp;
      <a href="#M000062">objects</a>&nbsp;&nbsp;
      <a href="#M000066">range</a>&nbsp;&nbsp;
      <a href="#M000058">show</a>&nbsp;&nbsp;
      <a href="#M000065">syndicate</a>&nbsp;&nbsp;
      <a href="#M000057">update</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="#M000063" class="method-signature">
          <span class="method-name">annoj</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
AnnoJ request method, not normally called directly used in config.yml and
config.js. Gets features for an experiment at id
</p>
<pre>
 =&gt; use /features/annoj/id
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000063-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000063-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 287</span>
287:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">annoj</span>
288:     <span class="ruby-comment cmt">#annoj does this funny, makes posts for just getting information .. meh </span>
289:     <span class="ruby-comment cmt">#we dont want this sooo need to separate out the annoj get from the proper</span>
290:     <span class="ruby-comment cmt">#rails resource request, this method handles only annoj requests...</span>
291:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">get?</span>
292:       <span class="ruby-comment cmt">##sort out the params from annoj's get</span>
293:       <span class="ruby-identifier">annoj_params</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">url</span>).<span class="ruby-identifier">query</span>)
294:       <span class="ruby-identifier">annoj_params</span>.<span class="ruby-identifier">each_pair</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>}
295:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'action'</span>]
296:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;syndicate&quot;</span>
297:           <span class="ruby-ivar">@response</span> = <span class="ruby-identifier">syndicate</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
298:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;describe&quot;</span>
299:           <span class="ruby-ivar">@response</span> = <span class="ruby-identifier">describe</span>(<span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">&quot;id&quot;</span>])
300:         <span class="ruby-keyword kw">end</span>
301:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@response</span>,  <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
302:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span>
303:       <span class="ruby-identifier">annoj_params</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">raw_post</span>)
304:       <span class="ruby-identifier">annoj_params</span>.<span class="ruby-identifier">each_pair</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>}
305:         <span class="ruby-comment cmt">#now do the specific stuff based on the annoj action... </span>
306:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'action'</span>]
307:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;range&quot;</span> 
308:             <span class="ruby-ivar">@response</span> = <span class="ruby-identifier">range</span>(<span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'assembly'</span>], <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'left'</span>], <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'right'</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'bases'</span>], <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'pixels'</span>])
309:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;lookup&quot;</span>
310:             <span class="ruby-ivar">@response</span> = <span class="ruby-identifier">lookup</span>(<span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">&quot;query&quot;</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
311:         <span class="ruby-keyword kw">end</span>
312:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@response</span>, <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
313:       <span class="ruby-keyword kw">end</span>
314:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">chromosome</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
AnnoJ request method, not normally called directly used in config.yml and
config.js. Gets reference track that is saved as experiment at id
</p>
<pre>
 =&gt; use /features/chromosome/id
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 317</span>
317:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">chromosome</span>
318:     
319:     <span class="ruby-comment cmt">#a method for returning chromosome sequence as if it were a read to trick annoj into showing a reference sequence...</span>
320:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">get?</span>
321:       <span class="ruby-comment cmt">##sort out the params from annoj's get</span>
322:       <span class="ruby-identifier">annoj_params</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">url</span>).<span class="ruby-identifier">query</span>)
323:       <span class="ruby-identifier">annoj_params</span>.<span class="ruby-identifier">each_pair</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>}
324:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'action'</span>]
325:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;syndicate&quot;</span>
326:           <span class="ruby-ivar">@response</span> = <span class="ruby-identifier">syndicate</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
327:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;describe&quot;</span>
328:           <span class="ruby-ivar">@response</span> = [] <span class="ruby-comment cmt">##to be done... </span>
329:       <span class="ruby-keyword kw">end</span>
330:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@response</span>,  <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
331:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">post?</span>
332:       <span class="ruby-identifier">annoj_params</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">raw_post</span>)
333:       <span class="ruby-identifier">annoj_params</span>.<span class="ruby-identifier">each_pair</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>}
334:         <span class="ruby-comment cmt">#now do the specific stuff based on the annoj action... </span>
335:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'action'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'range'</span>
336:           <span class="ruby-comment cmt">#remember params[:id] is genome id and annoj_params['assembly'] is the chromosome</span>
337:           <span class="ruby-identifier">sequence</span> = <span class="ruby-constant">Reference</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:genome_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'assembly'</span>]}).<span class="ruby-identifier">sequence</span>.<span class="ruby-identifier">sequence</span>
338:           <span class="ruby-identifier">subseq</span> = <span class="ruby-identifier">sequence</span>[<span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'left'</span>].<span class="ruby-identifier">to_i</span><span class="ruby-operator">..</span><span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'right'</span>].<span class="ruby-identifier">to_i</span>]
339:           <span class="ruby-identifier">f</span> = <span class="ruby-constant">LightFeature</span>.<span class="ruby-identifier">new</span>(
340:             <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'.'</span>,
341:             <span class="ruby-identifier">:feature</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'chromosome'</span>,
342:             <span class="ruby-identifier">:source</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'.'</span>,
343:             <span class="ruby-identifier">:start</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'left'</span>].<span class="ruby-identifier">to_i</span>,
344:             <span class="ruby-identifier">:end</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'right'</span>].<span class="ruby-identifier">to_i</span>, 
345:             <span class="ruby-identifier">:strand</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'+'</span>,
346:             <span class="ruby-identifier">:phase</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'.'</span>,
347:             <span class="ruby-identifier">:seqid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'assembly'</span>],
348:             <span class="ruby-identifier">:score</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'.'</span>,
349:             <span class="ruby-identifier">:experiment_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>,
350:             <span class="ruby-identifier">:gff_id</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-keyword kw">nil</span>,
351:             <span class="ruby-identifier">:sequence</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{subseq}&quot;</span>,
352:             <span class="ruby-identifier">:quality</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>,
353:             <span class="ruby-identifier">:reference_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>
354:           )
355:           <span class="ruby-identifier">zoom_factor</span> = <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'bases'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">'pixels'</span>].<span class="ruby-identifier">to_i</span>
356:           <span class="ruby-identifier">response</span> = <span class="ruby-identifier">new_response</span>
357:           <span class="ruby-identifier">features</span> = [<span class="ruby-identifier">f</span>]
358:           <span class="ruby-comment cmt">#@response = #range(annoj_params['assembly'], annoj_params['left'], annoj_params['right'], params[:id], annoj_params['bases'], annoj_params['pixels'])</span>
359:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">zoom_factor</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">10</span>
360:             <span class="ruby-identifier">hist_data</span> = <span class="ruby-identifier">get_histogram</span>(<span class="ruby-identifier">features</span>)
361:              <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
362:              <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:read</span>] = <span class="ruby-identifier">hist_data</span> 
363: 
364:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">zoom_factor</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">zoom_factor</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.1</span>
365:               <span class="ruby-identifier">box_data</span> = <span class="ruby-identifier">get_boxes</span>(<span class="ruby-identifier">features</span>)
366:               <span class="ruby-identifier">box_data</span>[<span class="ruby-identifier">:watson</span>][<span class="ruby-value">0</span>][<span class="ruby-value">0</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">seqid</span>
367:               <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
368:               <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:read</span>] = <span class="ruby-identifier">box_data</span>
369:           <span class="ruby-keyword kw">else</span>
370:               <span class="ruby-identifier">read_data</span> = <span class="ruby-identifier">get_reads</span>(<span class="ruby-identifier">features</span>)
371:               <span class="ruby-identifier">read_data</span>[<span class="ruby-identifier">:watson</span>][<span class="ruby-value">0</span>][<span class="ruby-value">0</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">seqid</span>
372:               <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
373:               <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:read</span>] = <span class="ruby-identifier">read_data</span>
374:           <span class="ruby-keyword kw">end</span>
375:           <span class="ruby-ivar">@response</span> = <span class="ruby-identifier">response</span>
376: 
377:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">annoj_params</span>[<span class="ruby-value str">&quot;action&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;lookup&quot;</span>
378:             <span class="ruby-ivar">@response</span> = [] <span class="ruby-comment cmt">#to be done also #lookup(annoj_params[&quot;query&quot;], params[:id])</span>
379:       <span class="ruby-keyword kw">end</span>
380:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@response</span>, <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
381:     <span class="ruby-keyword kw">end</span>
382:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="#M000061" class="method-signature">
          <span class="method-name">coverage</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Standard REST request method returns a hash summarising depth of feature
object <a href="FeaturesController.html#M000061">coverage</a> for a
nucleotides between start and stop on reference in experiment id
</p>
<pre>
 =&gt; use /features/coverage/id.format?params
 =&gt; required params: reference_id, start, end, experiment_id
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000061-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000061-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 222</span>
222:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">coverage</span>
223:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Experiment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]).<span class="ruby-identifier">uses_bam_file</span>  <span class="ruby-comment cmt">#return a pileup from samtools...</span>
224: 
225:     <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt">#return a position keyed hash of Positions objects</span>
226:       <span class="ruby-identifier">features</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find_in_range</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference_id</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
227:       <span class="ruby-identifier">sequence</span> = <span class="ruby-constant">Reference</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference_id</span>]).<span class="ruby-identifier">sequence</span>.<span class="ruby-identifier">sequence</span>[<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>,(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>].<span class="ruby-identifier">to_i</span>) ]
228:       <span class="ruby-identifier">positions</span> = <span class="ruby-constant">SimpleDepth</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>],<span class="ruby-identifier">sequence</span>,<span class="ruby-identifier">features</span>)
229:     <span class="ruby-comment cmt">#comp_hash = {'A' =&gt; 'T', 'T' =&gt; 'A', 'G' =&gt; 'C', 'C' =&gt; 'G', 'N' =&gt; 'N'}</span>
230:     <span class="ruby-comment cmt">#positions = Hash.new {|h,k| h[k] = {</span>
231:      <span class="ruby-comment cmt">#   '+' =&gt; {</span>
232:     <span class="ruby-comment cmt">#      'A' =&gt; 0, </span>
233:     <span class="ruby-comment cmt">#      'T' =&gt; 0, </span>
234:     <span class="ruby-comment cmt">#      'G' =&gt; 0, </span>
235:     <span class="ruby-comment cmt">#      'C' =&gt; 0, </span>
236:     <span class="ruby-comment cmt">#      'N' =&gt; 0, </span>
237:     <span class="ruby-comment cmt">#      'strand_total' =&gt; 0</span>
238:     <span class="ruby-comment cmt">#      }, </span>
239:     <span class="ruby-comment cmt">#    '-' =&gt; {</span>
240:     <span class="ruby-comment cmt">#      'A' =&gt; 0, </span>
241:     <span class="ruby-comment cmt">#      'T' =&gt; 0, </span>
242:     <span class="ruby-comment cmt">#      'G' =&gt; 0, </span>
243:      <span class="ruby-comment cmt">#     'C' =&gt; 0, </span>
244:     <span class="ruby-comment cmt">#      'N' =&gt; 0, </span>
245:     <span class="ruby-comment cmt">#      'strand_total' =&gt; 0</span>
246:     <span class="ruby-comment cmt">#      }, </span>
247:     <span class="ruby-comment cmt">#    'position_total' =&gt; 0</span>
248:     <span class="ruby-comment cmt">#  } </span>
249:     <span class="ruby-comment cmt">#}</span>
250:     <span class="ruby-comment cmt">#positions['region_total'] = 0</span>
251:     <span class="ruby-comment cmt">#positions['1'] = 1</span>
252:     <span class="ruby-comment cmt">#features = Feature.find_in_range_no_overlap(params[:reference_id],params[:start],params[:end],params[:id])</span>
253:     <span class="ruby-comment cmt">#features.each do |f|</span>
254:     <span class="ruby-comment cmt">#  if (f.sequence.match(/\w/))</span>
255:     <span class="ruby-comment cmt">#    (f.start .. f.end - 1).each_with_index do |i, idx|</span>
256:     <span class="ruby-comment cmt">#        positions[i][f.strand][f.sequence[idx,1]] += 1</span>
257:     <span class="ruby-comment cmt">#        positions[i][f.strand]['strand_total'] += 1</span>
258:     <span class="ruby-comment cmt">#        positions[i]['position_total'] += 1</span>
259:     <span class="ruby-comment cmt">#        positions['region_total'] += 1</span>
260:     <span class="ruby-comment cmt">#    end</span>
261:     <span class="ruby-comment cmt">#  end</span>
262:     <span class="ruby-keyword kw">end</span>
263:     <span class="ruby-identifier">respond</span>(<span class="ruby-identifier">positions</span>)
264:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">describe</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Feature.html">Feature</a> Metadata accessor, AnnoJ only
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 539</span>
539:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">describe</span>(<span class="ruby-identifier">id</span>)
540:     <span class="ruby-identifier">f</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:gff_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>} )
541:     <span class="ruby-identifier">response</span> = <span class="ruby-identifier">new_response</span>
542:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
543:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:id</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">gff_id</span>
544:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:assembly</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">seqid</span>
545:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:start</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">start</span>
546:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:end</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">end</span>
547:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:description</span>] = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">description</span>
548:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">response</span>
549:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000059" class="method-detail">
        <a name="M000059"></a>

        <div class="method-heading">
          <a href="#M000059" class="method-signature">
          <span class="method-name">destroy</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000059-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000059-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 147</span>
147:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy</span>
148:   <span class="ruby-comment cmt">## gets the feature by id and deletes it and any relationships where it is a parent</span>
149:   <span class="ruby-comment cmt">## this is a horrid way of doing this.. check for a better RAILS-Y way...</span>
150:   
151:     <span class="ruby-identifier">feature</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
152:     <span class="ruby-identifier">feature</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
153:       <span class="ruby-comment cmt">##remove the old feature as a parent...</span>
154:       <span class="ruby-identifier">new_parent_list</span> = [] 
155:       <span class="ruby-identifier">child</span>.<span class="ruby-identifier">parents</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent</span><span class="ruby-operator">|</span>
156:           <span class="ruby-identifier">new_parent_list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">parent</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">parent_feature</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]   
157:       <span class="ruby-keyword kw">end</span>
158:       <span class="ruby-comment cmt">##add the updated feature list as a parent to the child...</span>
159:       <span class="ruby-identifier">child</span>.<span class="ruby-identifier">parents</span> = <span class="ruby-identifier">new_parent_list</span>
160:       <span class="ruby-identifier">child</span>.<span class="ruby-identifier">save</span>
161:     <span class="ruby-keyword kw">end</span>
162:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">feature</span>.<span class="ruby-identifier">destroy</span>
163:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Feature was successfully destroyed.'</span>
164:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:index</span> 
165:     <span class="ruby-keyword kw">else</span>
166:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Feature could not be deleted'</span>
167:        <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:show</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>] 
168:     <span class="ruby-keyword kw">end</span>
169:     
170:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000056" class="method-detail">
        <a name="M000056"></a>

        <div class="method-heading">
          <a href="#M000056" class="method-signature">
          <span class="method-name">edit</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000056-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000056-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 12</span>
12:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
13:     <span class="ruby-ivar">@feature</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
14:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">get_boxes</span><span class="method-args">(features)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Formatting method for <a href="FeaturesController.html#M000066">range</a>,
AnnoJ only
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 525</span>
525:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_boxes</span>(<span class="ruby-identifier">features</span>)
526:     <span class="ruby-identifier">result</span> = {}
527:     <span class="ruby-identifier">result</span>[<span class="ruby-identifier">:watson</span>] = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strand</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'+'</span> }.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_box</span>}
528:     <span class="ruby-identifier">result</span>[<span class="ruby-identifier">:crick</span>] = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strand</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'-'</span> }.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_box</span>}
529:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
530:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">get_histogram</span><span class="method-args">(features)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Formatting method for <a href="FeaturesController.html#M000066">range</a>,
AnnoJ only
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 429</span>
429:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_histogram</span>(<span class="ruby-identifier">features</span>)
430:      <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">features</span>.<span class="ruby-identifier">empty?</span>
431:      <span class="ruby-identifier">results</span> = []
432:      <span class="ruby-comment cmt">#lower limit</span>
433:      <span class="ruby-identifier">left</span> = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">start</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">features</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">start</span> <span class="ruby-operator">%</span> <span class="ruby-value">10</span>)
434:      <span class="ruby-comment cmt">#upper limit</span>
435:      <span class="ruby-identifier">right</span> = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">end</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">features</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">end</span> <span class="ruby-operator">%</span> <span class="ruby-value">10</span>)
436:      <span class="ruby-comment cmt">#number of arrays</span>
437:      <span class="ruby-identifier">start</span> = <span class="ruby-identifier">left</span>
438:      <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">start</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">right</span>
439:        <span class="ruby-identifier">results</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">start</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>]
440:        <span class="ruby-identifier">start</span> <span class="ruby-operator">+=</span> <span class="ruby-value">10</span>
441:      <span class="ruby-keyword kw">end</span>
442:      <span class="ruby-identifier">features</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
443:        <span class="ruby-identifier">window</span> = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">start</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">f</span>.<span class="ruby-identifier">start</span> <span class="ruby-operator">%</span> <span class="ruby-value">10</span>)
444:        <span class="ruby-identifier">start_index</span> = <span class="ruby-keyword kw">nil</span>
445:        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">window</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">left</span> 
446:           <span class="ruby-identifier">start_index</span> = <span class="ruby-value">0</span>
447:        <span class="ruby-keyword kw">else</span>
448:          <span class="ruby-identifier">start_index</span> = (<span class="ruby-identifier">window</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">left</span>) <span class="ruby-operator">/</span> <span class="ruby-value">10</span>
449:        <span class="ruby-keyword kw">end</span>
450:        <span class="ruby-identifier">end_index</span> = <span class="ruby-identifier">start_index</span> <span class="ruby-operator">+</span> (((<span class="ruby-identifier">f</span>.<span class="ruby-identifier">end</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">start</span>) <span class="ruby-operator">-</span> ((<span class="ruby-identifier">f</span>.<span class="ruby-identifier">end</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">start</span>) <span class="ruby-operator">%</span> <span class="ruby-value">10</span>)) <span class="ruby-operator">/</span> <span class="ruby-value">10</span>)
451:        <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">index</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">start_index</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">end_index</span>
452:          <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">results</span>.<span class="ruby-identifier">length</span>
453:          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strand</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp re">/\+/</span>)
454:            <span class="ruby-identifier">results</span>[<span class="ruby-identifier">index</span>][<span class="ruby-value">1</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span> 
455:          <span class="ruby-keyword kw">else</span>
456:            <span class="ruby-identifier">results</span>[<span class="ruby-identifier">index</span>][<span class="ruby-value">2</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
457:          <span class="ruby-keyword kw">end</span>
458:        <span class="ruby-keyword kw">end</span>
459:      <span class="ruby-keyword kw">end</span>
460:      <span class="ruby-comment cmt">#temp = [start, 0, 0]</span>
461:      <span class="ruby-comment cmt">#features.each do |f|</span>
462:       <span class="ruby-comment cmt"># if f.start &gt; start + 10</span>
463:       <span class="ruby-comment cmt">#   results &lt;&lt; temp</span>
464:       <span class="ruby-comment cmt">#   start = start + 10</span>
465:       <span class="ruby-comment cmt">#   temp = [start, 0,0]</span>
466:       <span class="ruby-comment cmt"># end</span>
467:       <span class="ruby-comment cmt"># if f.strand.match(/\+/)</span>
468:       <span class="ruby-comment cmt">#   temp[1] += 1</span>
469:       <span class="ruby-comment cmt"># else</span>
470:       <span class="ruby-comment cmt">#   temp[2] += 1</span>
471:       <span class="ruby-comment cmt"># end</span>
472:      <span class="ruby-comment cmt">#end</span>
473:      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">results</span>
474:      <span class="ruby-comment cmt">#pluses = Array.new(features.last.end - features.first.start + 1, 0)</span>
475:      <span class="ruby-comment cmt">#minuses = Array.new(features.last.end - features.first.start + 1, 0)</span>
476:      <span class="ruby-comment cmt">#features.each do |f|</span>
477:      <span class="ruby-comment cmt">#  for i in f.start .. f.end</span>
478:      <span class="ruby-comment cmt">#    case f.strand</span>
479:      <span class="ruby-comment cmt">#    when '+'</span>
480:      <span class="ruby-comment cmt">#      pluses[i - start] = pluses[i - start] + 1</span>
481:      <span class="ruby-comment cmt">#   else</span>
482:      <span class="ruby-comment cmt">#      minuses[i - start] = minuses[i - start] + 1</span>
483:      <span class="ruby-comment cmt">#    end</span>
484:      <span class="ruby-comment cmt">#  end</span>
485:      <span class="ruby-comment cmt">#end</span>
486:      <span class="ruby-comment cmt">#result = Array.new</span>
487:      <span class="ruby-comment cmt">#while start &lt; features.last.end</span>
488:      <span class="ruby-comment cmt">#  result &lt;&lt; [start, pluses.slice!(0 .. 8).max, minuses.slice!(0 .. 8).max]</span>
489:      <span class="ruby-comment cmt">#  start += 10</span>
490:      <span class="ruby-comment cmt">#end</span>
491:      <span class="ruby-comment cmt">#return result</span>
492:      <span class="ruby-comment cmt">#hist = {}</span>
493:      <span class="ruby-comment cmt">#for pos in features.first.start .. features.last.end</span>
494:      <span class="ruby-comment cmt">#  hist[pos] = {}</span>
495:      <span class="ruby-comment cmt">#  hist[pos]['+'] = 0</span>
496:      <span class="ruby-comment cmt">#  hist[pos]['-'] = 0</span>
497:      <span class="ruby-comment cmt">#end</span>
498:      <span class="ruby-comment cmt">#features.each do |f|</span>
499:      <span class="ruby-comment cmt">#  for pos in f.start .. f.end</span>
500:      <span class="ruby-comment cmt">#    hist[pos][f.strand] = hist[pos][f.strand] + 1 </span>
501:      <span class="ruby-comment cmt">#  end</span>
502:      <span class="ruby-comment cmt">#end</span>
503:      <span class="ruby-comment cmt">#result = hist  </span>
504:      <span class="ruby-comment cmt">#result = []</span>
505:      <span class="ruby-comment cmt">####go through the hist and send [start, plus_intens, minus_intens] for each window of bases</span>
506:        <span class="ruby-comment cmt">##send max intensity in steps of ten</span>
507: 
508:      <span class="ruby-comment cmt">#start = features.first.start.to_i</span>
509:      <span class="ruby-comment cmt">#while start &lt; features.last.end</span>
510:      <span class="ruby-comment cmt">#  plus_intens = 0</span>
511:      <span class="ruby-comment cmt">#  minus_intens = 0</span>
512:      <span class="ruby-comment cmt">#  for pos in start .. (start + 9)</span>
513: 
514:      <span class="ruby-comment cmt">#    break if pos &gt; features.last.end</span>
515:      <span class="ruby-comment cmt">#    plus_intens = hist[pos]['+'] if hist[pos]['+'] &gt; plus_intens      </span>
516:      <span class="ruby-comment cmt">#    minus_intens = hist[pos]['-'] if hist[pos]['-'] &gt; minus_intens</span>
517:      <span class="ruby-comment cmt">#  end</span>
518: 
519:      <span class="ruby-comment cmt">#  result &lt;&lt; [start, plus_intens, minus_intens]</span>
520:      <span class="ruby-comment cmt">#  start += 10</span>
521:      <span class="ruby-comment cmt">#end</span>
522:      <span class="ruby-comment cmt">#return result</span>
523:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">get_reads</span><span class="method-args">(features)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Formatting method for <a href="FeaturesController.html#M000066">range</a>,
AnnoJ only
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 532</span>
532:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_reads</span>(<span class="ruby-identifier">features</span>)
533:     <span class="ruby-identifier">result</span> = {}
534:     <span class="ruby-identifier">result</span>[<span class="ruby-identifier">:watson</span>] = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strand</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'+'</span> }.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_read</span>}
535:     <span class="ruby-identifier">result</span>[<span class="ruby-identifier">:crick</span>] = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">strand</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'-'</span> }.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">to_read</span>}
536:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
537:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="#M000060" class="method-signature">
          <span class="method-name">graphic_range</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000060-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000060-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 172</span>
172:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">graphic_range</span>
173: 
174:     <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] = []
175:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:genome_id</span>]
176:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'A genome build must be selected'</span>
177:     <span class="ruby-keyword kw">end</span>
178:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:experiment</span>]
179:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'An experiment must be selected'</span>
180:     <span class="ruby-keyword kw">end</span>
181:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
182:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'A reference sequence name must be provided'</span> 
183:     <span class="ruby-keyword kw">end</span>
184:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>] = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>].<span class="ruby-identifier">nil?</span>
185:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>] = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>].<span class="ruby-identifier">nil?</span>
186:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\D/</span>
187:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'Start must be a positive numeric value'</span>
188:     <span class="ruby-keyword kw">end</span>
189:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\D/</span>
190:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'End must be a positive numeric value'</span>
191:     <span class="ruby-keyword kw">end</span>
192:     
193:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>]
194:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">'End value must be greater than (or equal to) start value'</span>
195:     <span class="ruby-keyword kw">end</span>
196:      
197:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>].<span class="ruby-identifier">empty?</span>
198:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:back</span>
199:       <span class="ruby-keyword kw">return</span>
200:     <span class="ruby-keyword kw">end</span>
201:     
202:     
203: 
204:     
205:   <span class="ruby-comment cmt">#method for returning preformatted feature objects in a range for plotting by the javascript feature renderer. Groups features with a parent that have type in list Features::aggregate_features.</span>
206:     <span class="ruby-identifier">ref</span> = <span class="ruby-constant">Reference</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:genome_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:genome_id</span>], <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference</span>]})
207:     <span class="ruby-ivar">@features</span> = []
208:     <span class="ruby-ivar">@start</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>]
209:     <span class="ruby-ivar">@end</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>]
210:     <span class="ruby-identifier">seen_features</span> = []
211:     <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find_in_range_no_overlap</span>(<span class="ruby-identifier">ref</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:experiment</span>]).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
212:       <span class="ruby-ivar">@features</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">descendants</span>
213:       <span class="ruby-comment cmt">#if we have already used </span>
214:     <span class="ruby-keyword kw">end</span>
215:         
216:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000055" class="method-detail">
        <a name="M000055"></a>

        <div class="method-heading">
          <a href="#M000055" class="method-signature">
          <span class="method-name">index</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000055-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000055-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 7</span>
 7:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
 8:     <span class="ruby-ivar">@genomes</span> = <span class="ruby-constant">Genome</span>.<span class="ruby-identifier">all</span>
 9:     <span class="ruby-ivar">@experiments</span> = <span class="ruby-constant">Experiment</span>.<span class="ruby-identifier">all</span>
10:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">lookup</span><span class="method-args">(query, id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Feature.html">Feature</a> metadata accessor, AnnoJ only
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 551</span>
551:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">lookup</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">id</span>)
552:     <span class="ruby-identifier">response</span> = <span class="ruby-identifier">new_response</span>
553:     <span class="ruby-identifier">rows</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;experiment_id = ? and features.group like ?&quot;</span>, <span class="ruby-identifier">id</span>, <span class="ruby-value str">&quot;%&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">query</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;%&quot;</span>]).<span class="ruby-identifier">collect!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">to_lookup</span>}
554:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:count</span>] = <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">length</span>
555:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:rows</span>] = <span class="ruby-identifier">rows</span>
556:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">response</span>
557:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000072" class="method-detail">
        <a name="M000072"></a>

        <div class="method-heading">
          <a href="#M000072" class="method-signature">
          <span class="method-name">new_response</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Empty response, AnnoJ only
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000072-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000072-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 559</span>
559:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new_response</span>
560:     {<span class="ruby-identifier">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }
561:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="#M000062" class="method-signature">
          <span class="method-name">objects</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Standard REST request method returns array of feature <a
href="FeaturesController.html#M000062">objects</a> within or overlapping
the given start and end on the reference in experiment
</p>
<pre>
 =&gt; use /features/objects/id?params
 =&gt; required params: reference_id, start, end, id
 =&gt; optional params: overlap (true or false, default = false), type (some GFF feature type) restrict objects by feature type
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000062-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000062-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 271</span>
271:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">objects</span>
272:     <span class="ruby-identifier">objects</span> = []
273:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:format</span>] = <span class="ruby-value str">'xml'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:format</span>]
274:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:overlap</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:overlap</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;true&quot;</span> <span class="ruby-comment cmt">#if we want to include objects that can fall onto the edge of the range</span>
275:       <span class="ruby-identifier">objects</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find_in_range</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference_id</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
276:     <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt">#if we want to include only objects entirely within the range</span>
277:       <span class="ruby-identifier">objects</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find_in_range_no_overlap</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:reference_id</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:start</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:end</span>],<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
278:     <span class="ruby-keyword kw">end</span>
279:     <span class="ruby-identifier">objects</span>.<span class="ruby-identifier">delete_if</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">feature</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:type</span>] } <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:type</span>].<span class="ruby-identifier">nil?</span>
280:     <span class="ruby-comment cmt">#respond(objects, params[:format])</span>
281:     <span class="ruby-identifier">respond</span> <span class="ruby-identifier">objects</span>
282:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">range</span><span class="method-args">(assembly, left, right, experiment_id, bases, pixels)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
AnnoJ request method, returns data formatted as per request parameters for
particular view
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 396</span>
396:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">range</span>(<span class="ruby-identifier">assembly</span>, <span class="ruby-identifier">left</span>, <span class="ruby-identifier">right</span>, <span class="ruby-identifier">experiment_id</span>, <span class="ruby-identifier">bases</span>, <span class="ruby-identifier">pixels</span>)
397:     <span class="ruby-identifier">zoom_factor</span> = <span class="ruby-identifier">bases</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">pixels</span>.<span class="ruby-identifier">to_i</span>
398:     <span class="ruby-identifier">response</span> = <span class="ruby-identifier">new_response</span>
399:     <span class="ruby-identifier">exp</span> = <span class="ruby-constant">Experiment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">experiment_id</span>)
400:     <span class="ruby-identifier">reference</span> = <span class="ruby-constant">Reference</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ? AND genome_id = ?&quot;</span>, <span class="ruby-node">&quot;#{ assembly }&quot;</span>, <span class="ruby-node">&quot;#{exp.genome_id}&quot;</span>])
401:     <span class="ruby-identifier">features</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find_in_range_no_overlap</span>(<span class="ruby-identifier">reference</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">left</span>, <span class="ruby-identifier">right</span>, <span class="ruby-identifier">experiment_id</span>)
402:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">response</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">features</span>.<span class="ruby-identifier">empty?</span>
403:     <span class="ruby-comment cmt">#case features.first.feature</span>
404:     
405:     <span class="ruby-comment cmt">#when </span>
406:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">allowed_read_types</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">features</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">feature</span>) <span class="ruby-comment cmt">#'polymerase_synthesis_read'</span>
407:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">zoom_factor</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">10</span>
408:        <span class="ruby-identifier">hist_data</span> = <span class="ruby-identifier">get_histogram</span>(<span class="ruby-identifier">features</span>)
409:        <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
410:        <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:read</span>] = <span class="ruby-identifier">hist_data</span> 
411:        <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">response</span>
412:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">zoom_factor</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">zoom_factor</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.1</span>
413:         <span class="ruby-identifier">box_data</span> = <span class="ruby-identifier">get_boxes</span>(<span class="ruby-identifier">features</span>)
414:         <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
415:         <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:read</span>] = <span class="ruby-identifier">box_data</span>
416:       <span class="ruby-keyword kw">else</span>
417:         <span class="ruby-identifier">read_data</span> = <span class="ruby-identifier">get_reads</span>(<span class="ruby-identifier">features</span>)
418:         <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
419:         <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>][<span class="ruby-identifier">:read</span>] = <span class="ruby-identifier">read_data</span>
420:       <span class="ruby-keyword kw">end</span>   
421:        
422:     <span class="ruby-keyword kw">else</span>
423:       <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = []
424:       <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = <span class="ruby-identifier">features</span>.<span class="ruby-identifier">collect!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">to_annoj</span> }
425:     <span class="ruby-keyword kw">end</span>
426:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">response</span>
427:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000058" class="method-detail">
        <a name="M000058"></a>

        <div class="method-heading">
          <a href="#M000058" class="method-signature">
          <span class="method-name">show</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000058-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000058-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 136</span>
136:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show</span> 
137:       <span class="ruby-ivar">@feature</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
138:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
139:         <span class="ruby-ivar">@feature</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
140:         <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span> = <span class="ruby-constant">JSON</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>(<span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span>)
141:         <span class="ruby-identifier">respond</span> <span class="ruby-ivar">@feature</span>
142:       <span class="ruby-keyword kw">else</span>
143:         <span class="ruby-identifier">respond</span> <span class="ruby-identifier">:false</span>
144:       <span class="ruby-keyword kw">end</span>
145:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">syndicate</span><span class="method-args">(id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
AnnoJ request method, returns metadata on a track required by AnnoJ
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 384</span>
384:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">syndicate</span>(<span class="ruby-identifier">id</span>)
385:     <span class="ruby-identifier">experiment</span> = <span class="ruby-constant">Experiment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>) 
386:     <span class="ruby-identifier">response</span> = <span class="ruby-identifier">new_response</span>
387:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = {}
388:     <span class="ruby-constant">JSON</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>( <span class="ruby-node">&quot;#{experiment.meta}&quot;</span> )
389:     
390:     <span class="ruby-identifier">response</span>[<span class="ruby-identifier">:data</span>] = <span class="ruby-constant">JSON</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>( <span class="ruby-node">&quot;#{experiment.meta}&quot;</span> )
391:     <span class="ruby-comment cmt">#response[:data][:engineer] = YAML::load( &quot;#{experiment.engineer}&quot;)</span>
392:     <span class="ruby-comment cmt">#response[:data][:service] = YAML::load( &quot;#{experiment.service}&quot;)</span>
393:     <span class="ruby-identifier">response</span>
394:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000057" class="method-detail">
        <a name="M000057"></a>

        <div class="method-heading">
          <a href="#M000057" class="method-signature">
          <span class="method-name">update</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000057-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000057-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/features_controller.rb, line 16</span>
 16:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
 17:     
 18:     <span class="ruby-comment cmt">##make the new feature for saving</span>
 19:     <span class="ruby-comment cmt">##get the form stuff, use the old feature for missing or un-updatable fields</span>
 20:     <span class="ruby-identifier">old_feature</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:old_feature_id</span>])
 21:     <span class="ruby-ivar">@feature</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">new</span>
 22:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">seqid</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:seqid</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">seqid</span>
 23:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">source</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:source</span>] 
 24:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">feature</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:feature</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">feature</span>
 25:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">start</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:start</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">start</span>
 26:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">end</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:end</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">end</span>
 27:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">score</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:score</span>] 
 28:     
 29:     <span class="ruby-identifier">strand</span> = <span class="ruby-keyword kw">nil</span>
 30:     <span class="ruby-identifier">strand</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:strand</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'plus'</span> <span class="ruby-operator">?</span> <span class="ruby-value str">'+'</span> <span class="ruby-operator">:</span> <span class="ruby-value str">'-'</span> 
 31:     
 32:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">strand</span> = <span class="ruby-identifier">strand</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">strand</span>
 33:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">phase</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:phase</span>] 
 34:     
 35:     
 36:     <span class="ruby-comment cmt">##get the genome from the reference, only look in the same reference... </span>
 37:     <span class="ruby-identifier">genome_id</span> = <span class="ruby-constant">Reference</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">reference_id</span>).<span class="ruby-identifier">genome_id</span>
 38: 
 39:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">reference_id</span> = <span class="ruby-constant">Reference</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:genome_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">genome_id</span>, <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">seqid</span>} ) <span class="ruby-operator">||</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">ref_id</span>
 40:     
 41:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span> = []
 42:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:group</span>]
 43:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:group</span>].<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">old_group</span><span class="ruby-operator">|</span>
 44:         <span class="ruby-comment cmt">##this is a little messy.. </span>
 45:         <span class="ruby-identifier">key</span> = <span class="ruby-identifier">old_group</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&quot;/</span>,<span class="ruby-value str">&quot;&quot;</span>).<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)[<span class="ruby-value">0</span>]
 46:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:group</span>][<span class="ruby-identifier">old_group</span>]
 47:         <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">key</span>,<span class="ruby-identifier">value</span>]
 48:       <span class="ruby-keyword kw">end</span>
 49:     <span class="ruby-keyword kw">end</span>
 50:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:new_group</span>]
 51:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:new_group</span>].<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pair</span><span class="ruby-operator">|</span>
 52:         <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:new_group</span>][<span class="ruby-identifier">pair</span>][<span class="ruby-identifier">:key</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:feature</span>][<span class="ruby-identifier">:new_group</span>][<span class="ruby-identifier">pair</span>][<span class="ruby-identifier">:value</span>] ]
 53:       <span class="ruby-keyword kw">end</span>
 54:     <span class="ruby-keyword kw">end</span>
 55:     
 56:     <span class="ruby-comment cmt">##fill in the uneditable fields</span>
 57:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">gff_id</span> = <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">gff_id</span>
 58:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">experiment_id</span> = <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">experiment_id</span>
 59:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">sequence</span> = <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">sequence</span>
 60:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">read_id</span> = <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">read_id</span>
 61:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">quality</span> = <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">quality</span>
 62:     
 63:     <span class="ruby-comment cmt">##set up the parents of the new feature from the group info</span>
 64:     <span class="ruby-identifier">parents</span> = <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Parent'</span> }
 65:     <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;parents are #{parents}&quot;</span>
 66:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">parents</span>.<span class="ruby-identifier">empty?</span>
 67:       <span class="ruby-identifier">parents</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">label</span>, <span class="ruby-identifier">parentFeature_gff_id</span><span class="ruby-operator">|</span>
 68:         <span class="ruby-identifier">parentFeats</span> = <span class="ruby-constant">Feature</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;gff_id = ?&quot;</span>, <span class="ruby-node">&quot;#{ parentFeature_gff_id }&quot;</span>] )
 69:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">parentFeats</span>)
 70:           <span class="ruby-identifier">parentFeats</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pf</span><span class="ruby-operator">|</span>
 71:             <span class="ruby-identifier">parent</span> = <span class="ruby-keyword kw">nil</span>
 72:             <span class="ruby-identifier">parent</span> = <span class="ruby-constant">Parent</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">:parent_feature</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pf</span>.<span class="ruby-identifier">id</span>})
 73:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">parent</span>
 74:               <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">save</span> 
 75:             <span class="ruby-keyword kw">else</span>
 76:               <span class="ruby-identifier">parent</span> = <span class="ruby-constant">Parent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:parent_feature</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pf</span>.<span class="ruby-identifier">id</span>)
 77:               <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">save</span> 
 78:             <span class="ruby-keyword kw">end</span>
 79:             <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">parents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">parent</span>
 80:           <span class="ruby-keyword kw">end</span>
 81:         <span class="ruby-keyword kw">end</span>
 82:       <span class="ruby-keyword kw">end</span>
 83:     <span class="ruby-keyword kw">end</span>
 84:     
 85:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">group</span>)
 86:     
 87:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">save</span>
 88:     <span class="ruby-identifier">new_parent</span> = <span class="ruby-constant">Parent</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:parent_feature</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">id</span>)
 89:     <span class="ruby-identifier">new_parent</span>.<span class="ruby-identifier">save</span>
 90: 
 91:     <span class="ruby-comment cmt">##set up the children of the new feature from the old one..</span>
 92:     <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
 93:       <span class="ruby-comment cmt">##remove the old feature as a parent...</span>
 94:       <span class="ruby-identifier">new_parent_list</span> = [<span class="ruby-identifier">new_parent</span>] 
 95:       <span class="ruby-identifier">child</span>.<span class="ruby-identifier">parents</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent</span><span class="ruby-operator">|</span>
 96:           <span class="ruby-identifier">new_parent_list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">parent</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">parent_feature</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">id</span>   
 97:       <span class="ruby-keyword kw">end</span>
 98:       <span class="ruby-comment cmt">##add the new feature as a parent to that child...</span>
 99:       <span class="ruby-identifier">child</span>.<span class="ruby-identifier">parents</span> = <span class="ruby-identifier">new_parent_list</span>
100:       <span class="ruby-identifier">child</span>.<span class="ruby-identifier">save</span>
101:     <span class="ruby-keyword kw">end</span>
102:     
103:     
104:     <span class="ruby-comment cmt">##setup the predecessor record from the old feature... </span>
105:     <span class="ruby-identifier">predecessor</span> = <span class="ruby-constant">Predecessor</span>.<span class="ruby-identifier">new</span>(
106:     <span class="ruby-identifier">:seqid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">seqid</span>,
107:     <span class="ruby-identifier">:source</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">source</span>,
108:     <span class="ruby-identifier">:feature</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">feature</span>,
109:     <span class="ruby-identifier">:start</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">start</span>,
110:     <span class="ruby-identifier">:end</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">end</span>,
111:     <span class="ruby-identifier">:score</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">score</span>,
112:     <span class="ruby-identifier">:strand</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">strand</span>,
113:     <span class="ruby-identifier">:phase</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">phase</span>,
114:     <span class="ruby-identifier">:gff_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">gff_id</span>,
115:     <span class="ruby-identifier">:reference_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">reference_id</span>,
116:     <span class="ruby-identifier">:experiment_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">experiment_id</span>,
117:     <span class="ruby-identifier">:created_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">created_at</span>,
118:     <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">group</span>
119:     )
120:     <span class="ruby-identifier">predecessor</span>.<span class="ruby-identifier">save</span>
121:     <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">predecessors</span> = [<span class="ruby-identifier">predecessor</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">predecessors</span>
122: 
123:     
124:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
125:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">save</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">old_feature</span>.<span class="ruby-identifier">destroy</span>
126:         <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'New feature was successfully created.'</span>
127:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:show</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@feature</span>.<span class="ruby-identifier">id</span> }
128:       <span class="ruby-keyword kw">else</span>
129:         <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'New feature failed to save...'</span>
130:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:edit</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:old_feature_id</span>]}
131:       <span class="ruby-keyword kw">end</span>
132:     <span class="ruby-keyword kw">end</span>
133:     
134:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>